 // src/hooks/usePageTitle.ts
// ‚úÖ Hook empresarial para manejo de t√≠tulos de p√°gina
// Mobile-first, SEO optimizado, integrado con HelmetProvider

import { useEffect } from 'react';
import { useLocation } from 'react-router-dom';
import { env } from '@/config/environment';
import { useCurrentUser } from '@/stores/authStore';

// ============================================
// TYPES SEGUROS
// ============================================

interface PageTitleOptions {
  title?: string;
  subtitle?: string;
  showUserName?: boolean;
  showOrganization?: boolean;
  template?: 'default' | 'admin' | 'portal' | 'auth';
  appendAppName?: boolean;
  separator?: string;
}

interface RouteMapping {
  pattern: RegExp;
  title: string;
  subtitle?: string;
  template?: PageTitleOptions['template'];
}

// ============================================
// ROUTE MAPPINGS (Basado en estructura del proyecto)
// ============================================

const ROUTE_MAPPINGS: RouteMapping[] = [
  // Auth routes
  { pattern: /^\/login/, title: 'Iniciar Sesi√≥n', template: 'auth' },
  { pattern: /^\/register/, title: 'Crear Cuenta', template: 'auth' },
  { pattern: /^\/forgot-password/, title: 'Recuperar Contrase√±a', template: 'auth' },
  { pattern: /^\/reset-password/, title: 'Restablecer Contrase√±a', template: 'auth' },
  
  // Dashboard
  { pattern: /^\/dashboard$/, title: 'Dashboard', subtitle: 'Resumen General' },
  { pattern: /^\/$/, title: 'Dashboard', subtitle: 'Resumen General' },
  
  // Contacts
  { pattern: /^\/contacts$/, title: 'Contactos', subtitle: 'Gesti√≥n de Contactos' },
  { pattern: /^\/contacts\/new/, title: 'Nuevo Contacto', subtitle: 'Crear Contacto' },
  { pattern: /^\/contacts\/(\d+)\/edit/, title: 'Editar Contacto', subtitle: 'Modificar Informaci√≥n' },
  { pattern: /^\/contacts\/(\d+)/, title: 'Detalle Contacto', subtitle: 'Informaci√≥n Completa' },
  { pattern: /^\/contacts\/import/, title: 'Importar Contactos', subtitle: 'Carga Masiva' },
  { pattern: /^\/contacts\/export/, title: 'Exportar Contactos', subtitle: 'Descarga de Datos' },
  
  // Companies
  { pattern: /^\/companies$/, title: 'Empresas', subtitle: 'Gesti√≥n de Empresas' },
  { pattern: /^\/companies\/new/, title: 'Nueva Empresa', subtitle: 'Crear Empresa' },
  { pattern: /^\/companies\/(\d+)\/edit/, title: 'Editar Empresa', subtitle: 'Modificar Informaci√≥n' },
  { pattern: /^\/companies\/(\d+)/, title: 'Detalle Empresa', subtitle: 'Informaci√≥n Completa' },
  
  // Deals/Pipeline
  { pattern: /^\/deals$/, title: 'Pipeline', subtitle: 'Gesti√≥n de Oportunidades' },
  { pattern: /^\/deals\/kanban/, title: 'Kanban Board', subtitle: 'Vista de Pipeline' },
  { pattern: /^\/deals\/new/, title: 'Nueva Oportunidad', subtitle: 'Crear Deal' },
  { pattern: /^\/deals\/(\d+)\/edit/, title: 'Editar Oportunidad', subtitle: 'Modificar Deal' },
  { pattern: /^\/deals\/(\d+)/, title: 'Detalle Oportunidad', subtitle: 'Informaci√≥n Completa' },
  
  // Activities
  { pattern: /^\/activities$/, title: 'Actividades', subtitle: 'Registro de Actividades' },
  { pattern: /^\/activities\/calendar/, title: 'Calendario', subtitle: 'Vista de Calendario' },
  { pattern: /^\/activities\/new/, title: 'Nueva Actividad', subtitle: 'Programar Actividad' },
  
  // Reports
  { pattern: /^\/reports$/, title: 'Reportes', subtitle: 'Analytics y M√©tricas' },
  { pattern: /^\/reports\/contacts/, title: 'Reporte de Contactos', subtitle: 'An√°lisis de Contactos' },
  { pattern: /^\/reports\/deals/, title: 'Reporte de Pipeline', subtitle: 'An√°lisis de Ventas' },
  { pattern: /^\/reports\/activities/, title: 'Reporte de Actividades', subtitle: 'An√°lisis de Productividad' },
  
  // Member Portal Integration
  { pattern: /^\/portal/, title: 'Portal de Miembros', subtitle: 'Integraci√≥n Digital' },
  { pattern: /^\/portal\/invitations/, title: 'Invitaciones', subtitle: 'Gesti√≥n de Accesos' },
  { pattern: /^\/portal\/engagement/, title: 'Engagement Digital', subtitle: 'M√©tricas de Participaci√≥n' },
  
  // Settings
  { pattern: /^\/settings$/, title: 'Configuraci√≥n', subtitle: 'Ajustes del Sistema', template: 'admin' },
  { pattern: /^\/settings\/profile/, title: 'Mi Perfil', subtitle: 'Informaci√≥n Personal' },
  { pattern: /^\/settings\/organization/, title: 'Organizaci√≥n', subtitle: 'Configuraci√≥n Organizacional', template: 'admin' },
  { pattern: /^\/settings\/users/, title: 'Usuarios', subtitle: 'Gesti√≥n de Usuarios', template: 'admin' },
  { pattern: /^\/settings\/integrations/, title: 'Integraciones', subtitle: 'APIs y Conectores', template: 'admin' },
  
  // Error pages
  { pattern: /^\/unauthorized/, title: 'Acceso Denegado', template: 'auth' },
  { pattern: /^\/404/, title: 'P√°gina No Encontrada', template: 'auth' },
  { pattern: /^\/500/, title: 'Error del Servidor', template: 'auth' },
];

// ============================================
// TITLE TEMPLATES
// ============================================

const buildTitle = (options: PageTitleOptions, user: any): string => {
  const {
    title = 'P√°gina',
    subtitle,
    showUserName = false,
    showOrganization = false,
    template = 'default',
    appendAppName = true,
    separator = ' - ',
  } = options;

  const parts: string[] = [];

  // T√≠tulo principal
  parts.push(title);

  // Subt√≠tulo si existe
  if (subtitle) {
    parts.push(subtitle);
  }

  // Nombre del usuario (mobile-first: solo iniciales en mobile)
  if (showUserName && user?.nombre) {
    const userName = user.nombre;
    parts.push(`(${userName})`);
  }

  // Organizaci√≥n si aplica
  if (showOrganization && user?.organizationId) {
    // En una implementaci√≥n real, podr√≠as tener el nombre de la org
    parts.push('Org');
  }

  // Template-specific modifications
  switch (template) {
    case 'admin':
      parts.unshift('Admin');
      break;
    case 'portal':
      parts.unshift('Portal');
      break;
    case 'auth':
      // Auth pages no llevan info adicional
      break;
  }

  // App name
  if (appendAppName) {
    parts.push(env.appName);
  }

  return parts.join(separator);
};

// ============================================
// HELPER FUNCTIONS
// ============================================

/**
 * Encuentra el mapeo de ruta que coincide con el pathname actual
 */
const findRouteMapping = (pathname: string): RouteMapping | null => {
  for (const mapping of ROUTE_MAPPINGS) {
    if (mapping.pattern.test(pathname)) {
      return mapping;
    }
  }
  return null;
};

/**
 * Extrae par√°metros de la ruta usando el patr√≥n
 */
const extractRouteParams = (pathname: string, pattern: RegExp): string[] => {
  const match = pathname.match(pattern);
  return match ? match.slice(1) : [];
};

/**
 * Actualiza el title del documento de forma segura
 */
const updateDocumentTitle = (title: string): void => {
  try {
    if (typeof document !== 'undefined') {
      document.title = title;
    }
  } catch (error) {
    console.warn('Failed to update document title:', error);
  }
};

/**
 * Genera meta tags para SEO (mobile-first)
 */
const generateMetaTags = (title: string, description?: string) => {
  const metaDescription = description || `${title} - ${env.appDescription}`;
  
  return {
    title,
    description: metaDescription,
    'og:title': title,
    'og:description': metaDescription,
    'twitter:title': title,
    'twitter:description': metaDescription,
  };
};

// ============================================
// MAIN HOOK
// ============================================

/**
 * Hook empresarial para manejo de t√≠tulos de p√°gina
 * Mobile-first, SEO optimizado, integrado con auth
 */
export const usePageTitle = (options?: PageTitleOptions) => {
  const location = useLocation();
  const user = useCurrentUser();

  useEffect(() => {
    // Determinar el t√≠tulo basado en la ruta actual
    const routeMapping = findRouteMapping(location.pathname);
    
    const finalOptions: PageTitleOptions = {
      // Defaults
      appendAppName: true,
      separator: ' - ',
      template: 'default',
      
      // From route mapping
      ...(routeMapping && {
        title: routeMapping.title,
        subtitle: routeMapping.subtitle,
        template: routeMapping.template,
      }),
      
      // User provided options (highest priority)
      ...options,
    };

    // Construir el t√≠tulo final
    const finalTitle = buildTitle(finalOptions, user);
    
    // Actualizar el documento
    updateDocumentTitle(finalTitle);

    // Log para debugging en desarrollo
    if (env.isDev) {
      console.log(`üìÑ Page title updated: "${finalTitle}"`);
    }

  }, [location.pathname, options, user]);

  // Return helper functions para uso avanzado
  return {
    updateTitle: (newOptions: PageTitleOptions) => {
      const finalTitle = buildTitle({ ...options, ...newOptions }, user);
      updateDocumentTitle(finalTitle);
      return finalTitle;
    },
    
    getCurrentTitle: () => {
      return typeof document !== 'undefined' ? document.title : '';
    },
    
    generateMetaTags: (description?: string) => {
      const currentTitle = typeof document !== 'undefined' ? document.title : env.appName;
      return generateMetaTags(currentTitle, description);
    },
  };
};

// ============================================
// CONVENIENCE HOOKS
// ============================================

/**
 * Hook simple para solo actualizar el t√≠tulo
 */
export const useSimplePageTitle = (title: string, subtitle?: string) => {
  return usePageTitle({ title, subtitle });
};

/**
 * Hook para p√°ginas de admin
 */
export const useAdminPageTitle = (title: string, subtitle?: string) => {
  return usePageTitle({ 
    title, 
    subtitle, 
    template: 'admin',
    showUserName: true 
  });
};

/**
 * Hook para p√°ginas de auth
 */
export const useAuthPageTitle = (title: string) => {
  return usePageTitle({ 
    title, 
    template: 'auth',
    appendAppName: true 
  });
};

/**
 * Hook para p√°ginas del portal de miembros
 */
export const usePortalPageTitle = (title: string, subtitle?: string) => {
  return usePageTitle({ 
    title, 
    subtitle, 
    template: 'portal',
    showOrganization: true 
  });
};

// ============================================
// EXPORT TYPES PARA USO EXTERNO
// ============================================

export type { PageTitleOptions, RouteMapping };
